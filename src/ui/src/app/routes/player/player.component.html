<app-header [anime]="anime$ | async"
            [user]="whoami$ | async"
            [notifications]="notifications$ | async">
  <app-uploader [uploadedByUser]="uploader$ | async"
                [isForeignSource]="videosService.currentVideo?.foreign"></app-uploader>
</app-header>
<div id="player" *ngIf="settings && (anime$ | async) as anime">
  <app-video-player [video]="videosService.currentVideo"></app-video-player>

  <ng-container *ngIf="(videosService.videos$ | async) as videos">
    <div id="filters"
         *ngIf="videos.length > 0 && settings.playerFiltersEnabled && (videosService.unique$ | async) as unique">
      <app-dropdown-filters *ngFor="let f of settings.playerFilters
                              | filterBy: ['enabled']:true as enabledFilters"
                            [unique]="unique"
                            [episode]="episode$ | async"
                            [ngStyle]="{ 'width.%':  100 / enabledFilters.length }"
                            (change)="filter[f.name] = $event"
                            column="{{ f.name }}"
                            placeholder="{{ f.name }}"></app-dropdown-filters>
    </div>

    <div id="controls">
      <app-control-box subtext="Предыдущий">
        <button mat-button
                [disabled]="+urlParams.episode - 1 < 1"
                (click)="changeEpisode(+urlParams.episode - 1)">
          <mat-icon>fast_rewind</mat-icon>
        </button>
      </app-control-box>
      <app-control-box subtext="прямая ссылка"
                       [href]="videosService.currentVideo?.url || '#'">
        <label for="shikicinema-episode"></label>
        <input id="shikicinema-episode"
               class="text"
               maxlength="5"
               [(ngModel)]="urlParams.episode"
               (ngModelChange)="changeEpisode($event)"
               value="1">
      </app-control-box>
      <app-control-box subtext="Следующий">
        <button mat-button
                [disabled]="+urlParams.episode + 1 > (anime.episodes || anime.episodes_aired)"
                (click)="changeEpisode(+urlParams.episode + 1)">
          <mat-icon>fast_forward</mat-icon>
        </button>
      </app-control-box>
      <app-control-box subtext="Просмотрено"
                       *ngIf="(whoami$ | async) as user else sync"
                       [matTooltip]="watched(urlParams.episode)
                                      ? 'Убрать отметку о просмотре'
                                      : 'Отметить как просмотренную'"
                       matTooltipPosition="after"
                       matTooltipShowDelay="1000"
                       (click)="watched(urlParams.episode)
                                ? watch(anime, +videosService.currentVideo?.episode - 1, user, 'Просмотр отменен')
                                : watch(anime, +videosService.currentVideo?.episode, user, 'Просмотрено')">
        <button mat-button
                [class.watched]="watched(urlParams.episode)">
          <mat-icon>done</mat-icon>
        </button>
      </app-control-box>
      <ng-template #sync>
        <app-control-box subtext="Шикимори"
                         matTooltip="Синхронизироваться с Шикимори"
                         matTooltipPosition="after"
                         matTooltipShowDelay="1000"
                         (click)="synchronize()">
          <button mat-button>
            <mat-icon>sync</mat-icon>
          </button>
        </app-control-box>
      </ng-template>

      <!-- those buttons will appear when related setting is on -->
      <ng-container *ngIf="settings.extraButtons">
        <app-control-box subtext="Загрузить"
                         *ngIf="(whoami$ | async) else lockedUpload"
                         matTooltip="Загрузить видео"
                         matTooltipPosition="after"
                         matTooltipShowDelay="1000">
          <button mat-button (click)="isUploadOpened ? closeUploadForm() : openUploadForm()">
            <mat-icon>add</mat-icon>
          </button>
        </app-control-box>
        <ng-template #lockedUpload>
          <app-control-box subtext="Загрузить"
                           matTooltip="Требуется авторизация на Шикимори">
            <button mat-button disabled>
              <mat-icon>add</mat-icon>
            </button>
          </app-control-box>
        </ng-template>
        <app-control-box subtext="Настройки"
                         matTooltip="Настойки плагина"
                         matTooltipPosition="after"
                         matTooltipShowDelay="1000">
          <button mat-button routerLink="/settings">
            <mat-icon>settings_applications</mat-icon>
          </button>
        </app-control-box>
      </ng-container>


        <mat-menu #extraButtonsMenu="matMenu">
          <!-- those buttons hidden in dropdown menu -->
          <ng-container *ngIf="!settings.extraButtons">
            <button mat-menu-item
                    [disabled]="!(whoami$ | async)?.id"
                    (click)="openUploadForm()">
              Загрузить видео
            </button>
            <button mat-menu-item
                    routerLink="/settings">
              Настройки
            </button>
          </ng-container>

          <button mat-menu-item
                  [disabled]="!(whoami$ | async)?.id || videosService.currentVideo?.id === EMPTY_VIDEO.id"
                  (click)="openRequestsDialog()">
            Жалоба
          </button>
          <button mat-menu-item
                  (click)="openAboutDialog()">
            О программе
          </button>
        </mat-menu>

        <app-control-box subtext="Меню"
                         matTooltip="Показать меню"
                         matTooltipPosition="after"
                         matTooltipShowDelay="1000">
          <button mat-button [matMenuTriggerFor]="extraButtonsMenu">
            <mat-icon>more_horiz</mat-icon>
          </button>
        </app-control-box>


    </div>

    <div>
      <div id="upload-form" *ngIf="isUploadOpened && (whoami$ | async) as user">
        <app-upload-video *ngIf="user && user.id"
                          (check)="changeVideo($event)"
                          (close)="closeUploadForm()"
                          [uploaderId]="user.id"
                          [animeId]="urlParams.animeId"
                          [episode]="urlParams.episode"></app-upload-video>
      </div>

      <ng-container *ngIf="settings && videos
              | filterBy:['language']:filter.language
              | filterBy:['author']:filter.author
              | filterBy:['quality']:filter.quality
              | filterBy:['url']:filter.player
             as filteredVideos">
        <div id="series" *ngIf="settings.oldFagApproves">
          <app-episodes-list *ngIf="videosService.unique$ | async as unique; else episodesGhost"
                             (change)="changeEpisode($event)"
                             [anime]="anime"
                             [episode]="urlParams.episode"
                             [unique]="unique"
                             [chosen]="videosService.currentVideo"></app-episodes-list>
          <app-video-list
            [videos]="filteredVideos"
            (change)="changeVideo($event)"
            [chosen]="videosService.currentVideo"></app-video-list>

          <ng-template #episodesGhost>
            <app-oldfag-episodes-list-skeleton></app-oldfag-episodes-list-skeleton>
          </ng-template>
        </div>
        <div *ngIf="!settings.oldFagApproves">
          <app-compact-video-list
            [videos]="filteredVideos"
            (change)="changeVideo($event)"
            [chosenId]="videosService.currentVideo?.id"></app-compact-video-list>
        </div>
      </ng-container>
    </div>
    <ng-container *ngIf="settings.displayComments">
      <app-comments (nextPage)="nextCommentsPage()"
                    (quote)="addQuote($event)"
                    (reply)="addReply($event)"
                    [comments]="commentsService.comments$ | async"
                    [hasNextPage]="commentsService.hasNextPage"
                    [newCommentsCount]="commentsService.pageSize"
                    [totalCommentsRemaining]="commentsService.commentsRemaining"></app-comments>
      <app-comment-form [anime]="anime$ | async"
                        [commentator]="whoami$ | async"
                        [episode]="episode$ | async"
                        [preview]="settings.displayCommentPreview"
                        [quote]="quotes$ | async"
                        [reply]="replies$ | async"
                        [topic]="commentsService.topic$ | async"
                        [users]="commentsService.users$ | async"></app-comment-form>
    </ng-container>

  </ng-container>
</div>

<app-notify></app-notify>
